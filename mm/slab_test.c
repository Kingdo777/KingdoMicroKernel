#include <mm/slab.h>
#include <common/kprint.h>
#include <common/errno.h>
#include <common/macro.h>

#define MAX_ALLOC_SIZE 2048 // 每次分配的最大字节数
#define NUM_OPERATIONS 1000 // 总分配和释放操作次数

// 记录两次分配的地址
void *allocation[NUM_OPERATIONS];
void *allocation_[NUM_OPERATIONS];

// 假设这些是你自定义的 slab 分配器的接口
int slab_free(void *addr); // 回收内存
void *slab_alloc(size_t size); // 分配内存

// 比较两个地址记录是否一致
static bool compare_allocations(void *allocations1[NUM_OPERATIONS], void *allocations2[NUM_OPERATIONS])
{
	for (int i = 0; i < NUM_OPERATIONS; i++) {
		if (allocations1[i] != allocations2[i]) {
			return false; // 如果有任何地址不一致，返回0
		}
	}
	return true; // 所有地址和大小一致，返回1
}

// 测试函数
void run_test(size_t sizes[NUM_OPERATIONS])
{
	// 记录每次分配的大小和地址
	for (int i = 0; i < NUM_OPERATIONS; i++) {
		size_t size = sizes[i]; // 获取预定大小
		allocation[i] = slab_alloc(size); // 按预定大小分配内存
		assert(allocation[i] != NULL); // 确保分配成功
	}
	// 释放所有分配的内存，倒序释放
	for (int i = 0; i < NUM_OPERATIONS; i++) {
		assert(slab_free(allocation[NUM_OPERATIONS - i - 1]) == 0); // 释放该地址
	}

	// 记录每次分配的大小和地址
	for (int i = 0; i < NUM_OPERATIONS; i++) {
		size_t size = sizes[i]; // 获取预定大小
		allocation_[i] = slab_alloc(size); // 按预定大小分配内存
		assert(allocation_[i] != NULL); // 确保分配成功
	}
	assert(compare_allocations(allocation,
				   allocation_)); // 比较两次分配的地址是否一致
	// 释放所有分配的内存，正序释放
	for (int i = 0; i < NUM_OPERATIONS; i++) {
		assert(slab_free(allocation_[i]) == 0); // 释放该地址
	}
}

void run_test1(size_t sizes[NUM_OPERATIONS])
{
	for (int i = 0; i < NUM_OPERATIONS; i++) {
		assert(slab_free(slab_alloc(sizes[i])) == 0);
	}
}

extern size_t sizes[];

int test_slab()
{
	int loop = 1000;
	int i = 0;
	unsigned long free_buddy_size_before = 0;
	unsigned long free_buddy_size_after = 0;

	kinfo("Start slab test");
	free_buddy_size_before = get_free_mem_size_from_buddy();
	while (loop-- > 0) {
		if (loop % (100) == 0) {
			printk("...%d%%", (i++) * 10);
		}
		run_test1(sizes);
		run_test(sizes);
	}
	free_buddy_size_after = get_free_mem_size_from_buddy();
	assert(free_buddy_size_after == free_buddy_size_before); // 确保释放的内存和分配的内存一致
	printk("...100%%\n");
	kinfo("Slab test passed\n");

	return 0;
}

size_t sizes[2000] = {
	1121, 482,  1469, 648,	1204, 413,  1096, 302,	704,  1008, 1517, 1110, 1992, 865,  815,  1577, 227,  1799,
	648,  1178, 1357, 286,	1795, 776,  1974, 654,	1363, 1239, 1555, 338,	1467, 274,  740,  929,	1180, 226,
	1327, 1055, 1595, 1077, 1091, 1775, 680,  1030, 247,  1817, 1706, 475,	797,  799,  1588, 1052, 531,  1985,
	1399, 1061, 878,  1272, 522,  1024, 1299, 1899, 1214, 1069, 302,  893,	720,  387,  295,  1108, 225,  1450,
	1759, 1390, 1095, 330,	1362, 1254, 726,  982,	235,  1131, 238,  1869, 754,  445,  987,  951,	1006, 1156,
	1223, 1259, 855,  1300, 1877, 539,  1196, 397,	338,  1265, 1341, 1278, 271,  343,  681,  978,	1393, 268,
	1669, 1718, 1531, 753,	330,  1067, 1815, 313,	1004, 705,  1222, 1433, 1790, 1244, 582,  1765, 1106, 1559,
	1172, 552,  838,  270,	446,  1764, 988,  1362, 1206, 1621, 507,  680,	592,  503,  1181, 883,	289,  935,
	1729, 657,  1117, 1282, 745,  1734, 604,  1670, 819,  1511, 331,  1154, 1273, 1170, 1361, 254,	973,  289,
	819,  644,  1024, 1521, 1628, 1334, 780,  1425, 700,  990,  1841, 1974, 907,  596,  476,  1307, 1410, 604,
	695,  1563, 368,  553,	932,  1612, 1348, 1538, 1339, 1568, 1429, 1483, 1071, 984,  979,  1012, 1416, 1313,
	1037, 593,  1970, 1029, 1094, 1967, 628,  1089, 894,  1320, 1419, 1059, 789,  1372, 1369, 510,	459,  606,
	1730, 1098, 1057, 470,	477,  1545, 1619, 1622, 896,  544,  1123, 417,	1837, 1171, 505,  833,	408,  1016,
	1041, 1309, 276,  736,	930,  1135, 1528, 847,	1867, 1700, 1296, 1284, 1202, 1498, 1437, 609,	1257, 946,
	1183, 1447, 1118, 920,	755,  881,  909,  1247, 661,  1229, 1137, 332,	1753, 1979, 773,  1242, 1459, 512,
	791,  1049, 764,  1097, 1136, 1454, 1237, 1030, 1747, 1981, 1366, 559,	552,  455,  1315, 1377, 671,  453,
	508,  1562, 417,  759,	1245, 1375, 1144, 1499, 303,  1025, 324,  739,	671,  982,  832,  1617, 1472, 1103,
	1940, 1182, 843,  1046, 656,  1035, 431,  1754, 927,  1376, 836,  1290, 503,  738,  1125, 1129, 1346, 1707,
	1310, 1542, 1430, 587,	1195, 1000, 508,  924,	1054, 741,  1682, 324,	1143, 1027, 1104, 1044, 992,  768,
	455,  1589, 819,  1225, 1600, 986,  1420, 1749, 1719, 1066, 1544, 1411, 1515, 623,  960,  1153, 1090, 889,
	1200, 1380, 1241, 806,	1758, 616,  1335, 513,	981,  1596, 1674, 1382, 505,  1064, 960,  1350, 1943, 908,
	1671, 477,  1413, 1126, 817,  1220, 673,  1297, 1354, 1173, 1679, 1813, 1293, 1007, 676,  471,	882,  959,
	1627, 1453, 1179, 664,	987,  1969, 1344, 1015, 1853, 1142, 1100, 1463, 832,  1149, 836,  919,	1739, 852,
	1111, 1001, 563,  1417, 1715, 858,  455,  1115, 1068, 945,  875,  919,	493,  1291, 1689, 1919, 982,  1345,
	1249, 1368, 516,  1043, 1844, 1688, 834,  1394, 1177, 938,  1385, 1947, 1745, 792,  1660, 1203, 1034, 1495,
	952,  1905, 857,  649,	1075, 882,  1175, 1228, 1003, 1060, 720,  665,	1240, 987,  508,  1292, 1120, 925,
	1058, 1774, 1121, 482,	1469, 648,  1204, 413,	1096, 302,  704,  1008, 1517, 1110, 1992, 865,	815,  1577,
	227,  1799, 648,  1178, 1357, 286,  1795, 776,	1974, 654,  1363, 1239, 1555, 338,  1467, 274,	740,  929,
	1180, 226,  1327, 1055, 1595, 1077, 1091, 1775, 680,  1030, 247,  1817, 1706, 475,  797,  799,	1588, 1052,
	531,  1985, 1399, 1061, 878,  1272, 522,  1024, 1299, 1899, 1214, 1069, 302,  893,  720,  387,	295,  1108,
	225,  1450, 1759, 1390, 1095, 330,  1362, 1254, 726,  982,  235,  1131, 238,  1869, 754,  445,	987,  951,
	1006, 1156, 1223, 1259, 855,  1300, 1877, 539,	1196, 397,  338,  1265, 1341, 1278, 271,  343,	681,  978,
	1393, 268,  1669, 1718, 1531, 753,  330,  1067, 1815, 313,  1004, 705,	1222, 1433, 1790, 1244, 582,  1765,
	1106, 1559, 1172, 552,	838,  270,  446,  1764, 988,  1362, 1206, 1621, 507,  680,  592,  503,	1181, 883,
	289,  935,  1729, 657,	1117, 1282, 745,  1734, 604,  1670, 819,  1511, 331,  1154, 1273, 1170, 1361, 254,
	973,  289,  819,  644,	1024, 1521, 1628, 1334, 780,  1425, 700,  990,	1841, 1974, 907,  596,	476,  1307,
	1410, 604,  695,  1563, 368,  553,  932,  1612, 1348, 1538, 1339, 1568, 1429, 1483, 1071, 984,	979,  1012,
	1416, 1313, 1037, 593,	1970, 1029, 1094, 1967, 628,  1089, 894,  1320, 1419, 1059, 789,  1372, 1369, 510,
	459,  606,  1730, 1098, 1057, 470,  477,  1545, 1619, 1622, 896,  544,	1123, 417,  1837, 1171, 505,  833,
	408,  1016, 1041, 1309, 276,  736,  930,  1135, 1528, 847,  1867, 1700, 1296, 1284, 1202, 1498, 1437, 609,
	1257, 946,  1183, 1447, 1118, 920,  755,  881,	909,  1247, 661,  1229, 1137, 332,  1753, 1979, 773,  1242,
	1459, 512,  791,  1049, 764,  1097, 1136, 1454, 1237, 1030, 1747, 1981, 1366, 559,  552,  455,	1315, 1377,
	671,  453,  508,  1562, 417,  759,  1245, 1375, 1144, 1499, 303,  1025, 324,  739,  671,  982,	832,  1617,
	1472, 1103, 1940, 1182, 843,  1046, 656,  1035, 431,  1754, 927,  1376, 836,  1290, 503,  738,	1125, 1129,
	1346, 1707, 1310, 1542, 1430, 587,  1195, 1000, 508,  924,  1054, 741,	1682, 324,  1143, 1027, 1104, 1044,
	992,  768,  455,  1589, 819,  1225, 1600, 986,	1420, 1749, 1719, 1066, 1544, 1411, 1515, 623,	960,  1153,
	1090, 889,  1200, 1380, 1241, 806,  1758, 616,	1335, 513,  981,  1596, 1674, 1382, 505,  1064, 960,  1350,
	1943, 908,  1671, 477,	1413, 1126, 817,  1220, 673,  1297, 1354, 1173, 1679, 1813, 1293, 1007, 676,  471,
	882,  959,  1627, 1453, 1179, 664,  987,  1969, 1344, 1015, 1853, 1142, 1100, 1463, 832,  1149, 836,  919,
	1739, 852,  1111, 1001, 563,  1417, 1715, 858,	455,  1115, 1068, 945,	875,  919,  493,  1291, 1689, 1919,
	982,  1345, 1249, 1368, 516,  1043, 1844, 1688, 834,  1394, 1177, 938,	1385, 1947, 1745, 792,	1660, 1203,
	1034, 1495, 952,  1905, 857,  649,  1075, 882,	1175, 1228, 1003, 1060, 720,  665,  1240, 987,	508,  1292,
	1120, 925,  1058, 1774, 1121, 482,  1469, 648,	1204, 413,  1096, 302,	704,  1008, 1517, 1110, 1992, 865,
	815,  1577, 227,  1799, 648,  1178, 1357, 286,	1795, 776,  1974, 654,	1363, 1239, 1555, 338,	1467, 274,
	740,  929,  1180, 226,	1327, 1055, 1595, 1077, 1091, 1775, 680,  1030, 247,  1817, 1706, 475,	797,  799,
	1588, 1052, 531,  1985, 1399, 1061, 878,  1272, 522,  1024, 1299, 1899, 1214, 1069, 302,  893,	720,  387,
	295,  1108, 225,  1450, 1759, 1390, 1095, 330,	1362, 1254, 726,  982,	235,  1131, 238,  1869, 754,  445,
	987,  951,  1006, 1156, 1223, 1259, 855,  1300, 1877, 539,  1196, 397,	338,  1265, 1341, 1278, 271,  343,
	681,  978,  1393, 268,	1669, 1718, 1531, 753,	330,  1067, 1815, 313,	1004, 705,  1222, 1433, 1790, 1244,
	582,  1765, 1106, 1559, 1172, 552,  838,  270,	446,  1764, 988,  1362, 1206, 1621, 507,  680,	592,  503,
	1181, 883,  289,  935,	1729, 657,  1117, 1282, 745,  1734, 604,  1670, 819,  1511, 331,  1154, 1273, 1170,
	1361, 254,  973,  289,	819,  644,  1024, 1521, 1628, 1334, 780,  1425, 700,  990,  1841, 1974, 907,  596,
	476,  1307, 1410, 604,	695,  1563, 368,  553,	932,  1612, 1348, 1538, 1339, 1568, 1429, 1483, 1071, 984,
	979,  1012, 1416, 1313, 1037, 593,  1970, 1029, 1094, 1967, 628,  1089, 894,  1320, 1419, 1059, 789,  1372,
	1369, 510,  459,  606,	1730, 1098, 1057, 470,	477,  1545, 1619, 1622, 896,  544,  1123, 417,	1837, 1171,
	505,  833,  408,  1016, 1041, 1309, 276,  736,	930,  1135, 1528, 847,	1867, 1700, 1296, 1284, 1202, 1498,
	1437, 609,  1257, 946,	1183, 1447, 1118, 920,	755,  881,  909,  1247, 661,  1229, 1137, 332,	1753, 1979,
	773,  1242, 1459, 512,	791,  1049, 764,  1097, 1136, 1454, 1237, 1030, 1747, 1981, 1366, 559,	552,  455,
	1315, 1377, 671,  453,	508,  1562, 417,  759,	1245, 1375, 1144, 1499, 303,  1025, 324,  739,	671,  982,
	832,  1617, 1472, 1103, 1940, 1182, 843,  1046, 656,  1035, 431,  1754, 927,  1376, 836,  1290, 503,  738,
	1125, 1129, 1346, 1707, 1310, 1542, 1430, 587,	1195, 1000, 508,  924,	1054, 741,  1682, 324,	1143, 1027,
	1104, 1044, 992,  768,	455,  1589, 819,  1225, 1600, 986,  1420, 1749, 1719, 1066, 1544, 1411, 1515, 623,
	960,  1153, 1090, 889,	1200, 1380, 1241, 806,	1758, 616,  1335, 513,	981,  1596, 1674, 1382, 505,  1064,
	960,  1350, 1943, 908,	1671, 477,  1413, 1126, 817,  1220, 673,  1297, 1354, 1173, 1679, 1813, 1293, 1007,
	676,  471,  882,  959,	1627, 1453, 1179, 664,	987,  1969, 1344, 1015, 1853, 1142, 1100, 1463, 832,  1149,
	836,  919,  1739, 852,	1111, 1001, 563,  1417, 1715, 858,  455,  1115, 1068, 945,  875,  919,	493,  1291,
	1689, 1919, 982,  1345, 1249, 1368, 516,  1043, 1844, 1688, 834,  1394, 1177, 938,  1385, 1947, 1745, 792,
	1660, 1203, 1034, 1495, 952,  1905, 857,  649,	1075, 882,  1175, 1228, 1003, 1060, 720,  665,	1240, 987,
	508,  1292, 1120, 925,	1058, 1774, 1121, 482,	1469, 648,  1204, 413,	1096, 302,  704,  1008, 1517, 1110,
	1992, 865,  815,  1577, 227,  1799,
};
